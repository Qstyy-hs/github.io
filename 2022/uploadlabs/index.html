<!DOCTYPE html>
<html lang=zh-CN>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        靶场日记-Uploadlabs - Kmoon_Hs
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>
<body>
    <script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?cb7a49e4f6a740b15e6fd25de2803712";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 千山同一月,万物皆清明 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.png" />
        </div>
        <div class="name">
            <i>Kmoon</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-01-JS%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81"><span class="toc-text">Pass-01 JS前端验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-02-MIME%E9%AA%8C%E8%AF%81"><span class="toc-text">Pass-02 MIME验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-03-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-03 文件名后缀校验（黑名单绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-04-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="toc-text">Pass-04 文件名后缀校验（配置文件解析控制）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-05-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="toc-text">Pass-05 文件名后缀校验（配置文件解析控制）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-06-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-06 文件名后缀校验（大小写绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-07-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-07 文件名后缀校验（空格绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-08-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E7%82%B9%E5%8F%B7%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-08 文件名后缀校验（点号绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-09-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88-DATA%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-09 文件名后缀校验（::$DATA绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-10-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E6%8B%BC%E6%8E%A5%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-10 文件名后缀校验（拼接绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-11-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80%E6%A0%A1%E9%AA%8C%EF%BC%88%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-11 文件名后缀校验（双写绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-12-%E7%99%BD%E5%90%8D%E5%8D%95%E6%A0%A1%E9%AA%8C%EF%BC%88GET%E5%9E%8B0x00%E6%88%AA%E6%96%AD%EF%BC%89"><span class="toc-text">Pass-12 白名单校验（GET型0x00截断）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-13-%E7%99%BD%E5%90%8D%E5%8D%95%E6%A0%A1%E9%AA%8C%EF%BC%88POST%E5%9E%8B0x00%E6%88%AA%E6%96%AD%EF%BC%89"><span class="toc-text">Pass-13 白名单校验（POST型0x00截断）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-14-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B%EF%BC%88%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A0%A1%E9%AA%8C%EF%BC%89"><span class="toc-text">Pass-14 文件内容检测（文件头校验）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-15-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B-%EF%BC%88getimagesize-%E6%A0%A1%E9%AA%8C%EF%BC%89"><span class="toc-text">Pass-15 文件内容检测 （getimagesize()校验）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-16-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B%EF%BC%88exif-imagetype-%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-16 文件内容检测（exif_imagetype()绕过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-17-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B%EF%BC%88%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%EF%BC%89"><span class="toc-text">Pass-17 文件内容检测（二次渲染）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-18-%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%EF%BC%89"><span class="toc-text">Pass-18 逻辑漏洞（条件竞争）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pass-19-%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89-%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%89"><span class="toc-text">Pass-19 逻辑漏洞（条件竞争-图片马）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pass-21-%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87%EF%BC%89"><span class="toc-text">Pass-21 逻辑漏洞（数组绕过）</span></a>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 千山同一月,万物皆清明 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        <div class="post-container">
    <div class="post-title">
        靶场日记-Uploadlabs
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2022-08-24 11:20:37</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#upload" title="upload">upload</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h3 id="Pass-01-JS前端验证"><a href="#Pass-01-JS前端验证" class="headerlink" title="Pass-01 JS前端验证"></a>Pass-01 JS前端验证</h3><p>漏洞描述：利用前端js对上传文件后缀进行校验，后端没有进行检测</p>
<p>利用方法：</p>
<p>1.浏览器F12-&gt;F1 禁用js</p>
<p>2.bp抓包 先上传白名单后缀文件 修改后缀后放包</p>
<h3 id="Pass-02-MIME验证"><a href="#Pass-02-MIME验证" class="headerlink" title="Pass-02 MIME验证"></a>Pass-02 MIME验证</h3><p>漏洞描述：只检测数据包中Content-Type字段导致的漏洞</p>
<p>后端利用PHP的全局数组$_FILES()获取上传文件类型Type</p>
<p>利用方法：</p>
<p>修改content-type字段的值为白名单</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">常用content-type字段：
image/jpeg	jpg图片格式
image/png	png图片格式
image/gif	gif图片格式
text/palin	纯文本格式
text/xml	XML格式
text/html	HTML格式<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Pass-03-文件名后缀校验（黑名单绕过）"><a href="#Pass-03-文件名后缀校验（黑名单绕过）" class="headerlink" title="Pass-03 文件名后缀校验（黑名单绕过）"></a>Pass-03 文件名后缀校验（黑名单绕过）</h3><p>漏洞描述：使用黑名单的方式限制文件上传类型，后端利用$_FILES()和strrchr()获取文件名后缀</p>
<p>被限制文件类型：.asp .aspx .php .jsp</p>
<p>利用方法：</p>
<p>因为是利用黑名单来限制文件上传类型，找漏网之鱼绕过</p>
<p>例如：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">特殊文件名绕过： .php3 .php4 .php5 .phtml .phtm .phps .phpt .php345<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Pass-04-文件名后缀校验（配置文件解析控制）"><a href="#Pass-04-文件名后缀校验（配置文件解析控制）" class="headerlink" title="Pass-04 文件名后缀校验（配置文件解析控制）"></a>Pass-04 文件名后缀校验（配置文件解析控制）</h3><p>漏洞描述：</p>
<p>依然是使用黑名单限制，但几乎过滤了所有脚本文件的后缀名，但可以允许上传.htaccess文件。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。
通过htaccess文件，可以实现：
1.网页301重定向
2.自定义404错误页面
3.改变文件扩展名
4.允许/阻止特定的用户或者目录的访问
5.禁止目录列表
6.配置默认文档等功能<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用方法：</p>
<p>上传.htaccess解析文件，利用其配置，将白名单文件的类型解析成php文件类型。</p>
<p>上传.htaccess文件 内容如下：(将服务器上的test.jpg文件解析成php文件，这里文件可以自由配置)</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FilesMatch</span> <span class="token attr-name">"test.jpg"</span><span class="token punctuation">&gt;</span></span>         
SetHandler application/x-httpd-php
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FilesMatch</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>再上传一个一句话木马，文件名为test.jpg，依旧访问test.jpg，但其会以php形式显示</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="Pass-05-文件名后缀校验（配置文件解析控制）"><a href="#Pass-05-文件名后缀校验（配置文件解析控制）" class="headerlink" title="Pass-05 文件名后缀校验（配置文件解析控制）"></a>Pass-05 文件名后缀校验（配置文件解析控制）</h3><p>漏洞描述：过滤了.htaccess</p>
<p>利用方法：</p>
<p>使用大小写绕过.htaccess</p>
<p>利用.user.ini配置文件</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">.user.ini。它比.htaccess用的更广泛，不管服务器是nginx/apache/IIS，当使用CGI／FastCGI来解析php时，php会优先搜索目录下所有的.ini文件，并应用其中的配置。类似于apache的.htaccess，但语法与.htacces不同，语法跟php.ini一致。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上传文件 .user.ini,内容为：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">auto_prepend_file=test.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再上传一个内容为php一句话脚本，命名为test.jpg。</p>
<p>.user.ini文件作用：所有的php文件都自动包含test.jpg文件。.user.ini相当于一个用户自定义的php.ini。</p>
<h3 id="Pass-06-文件名后缀校验（大小写绕过）"><a href="#Pass-06-文件名后缀校验（大小写绕过）" class="headerlink" title="Pass-06 文件名后缀校验（大小写绕过）"></a>Pass-06 文件名后缀校验（大小写绕过）</h3><p>漏洞描述：</p>
<p>对于文件名后缀的校验时，没有进行通用的大小转换后的校验-&gt;strtolower()</p>
<p>大小写绕过原理：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">Windows系统下，对于文件名中的大小写不敏感。例如：test.php和TeSt.PHP是一样的。
Linux系统下，对于文件名中的大小写敏感。例如：test.php和 TesT.php就是不一样的。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>利用方法：文件后缀为.PHP</p>
<h3 id="Pass-07-文件名后缀校验（空格绕过）"><a href="#Pass-07-文件名后缀校验（空格绕过）" class="headerlink" title="Pass-07 文件名后缀校验（空格绕过）"></a>Pass-07 文件名后缀校验（空格绕过）</h3><p>漏洞描述：</p>
<p>对上传的文件名未做去空格的操作-&gt;trim()函数</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">Windows系统下，对于文件名中空格会被作为空处理，程序中的检测代码却不能自动删除空格。从而绕过黑名单。
即使用".php "不会被黑名单“.php”识别出来<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>利用方法：burp抓包，修改对应的文件名 添加空格。</p>
<h3 id="Pass-08-文件名后缀校验（点号绕过）"><a href="#Pass-08-文件名后缀校验（点号绕过）" class="headerlink" title="Pass-08 文件名后缀校验（点号绕过）"></a>Pass-08 文件名后缀校验（点号绕过）</h3><p>漏洞描述：</p>
<p>对上传的文件后缀名未做去点.的操作 -&gt;strrchr($file_name, ‘.’)</p>
<pre><code>利用Windows系统下，文件后缀名最后一个点会被自动去除的特性。
即使用".php."不会被黑名单“.php”识别出来
</code></pre>
<p>利用方法：文件后缀名为 .php.</p>
<h3 id="Pass-09-文件名后缀校验（-DATA绕过）"><a href="#Pass-09-文件名后缀校验（-DATA绕过）" class="headerlink" title="Pass-09 文件名后缀校验（::$DATA绕过）"></a>Pass-09 文件名后缀校验（::$DATA绕过）</h3><p>漏洞描述：</p>
<p>对上传的文件后缀名未做去除::$DATA处理</p>
<pre><code>Windows系统下，如果上传的文件名为test.php::$DATA会在服务器上生成一个test.php的文件，其中内容和所上传文件内容相同，并被解析。
</code></pre>
<p>利用方法：</p>
<p>上传带有一句话木马的文件，其文件名为test.php::$DATA</p>
<h3 id="Pass-10-文件名后缀校验（拼接绕过）"><a href="#Pass-10-文件名后缀校验（拼接绕过）" class="headerlink" title="Pass-10 文件名后缀校验（拼接绕过）"></a>Pass-10 文件名后缀校验（拼接绕过）</h3><p>漏洞描述：</p>
<p>将文件名进行过滤操作后，将文件名拼接在路径后面，所以需要绕过前面的<strong>首尾去空以及去点</strong>。</p>
<p>利用方法：</p>
<p>上传文件名为 .php. .(点+php+点+空格+点)</p>
<h3 id="Pass-11-文件名后缀校验（双写绕过）"><a href="#Pass-11-文件名后缀校验（双写绕过）" class="headerlink" title="Pass-11 文件名后缀校验（双写绕过）"></a>Pass-11 文件名后缀校验（双写绕过）</h3><p>漏洞描述：</p>
<p>利用str_ireplace()函数将文件名中符合黑名单的字符串替换成空</p>
<p>利用方式：</p>
<p>利用<strong>双写</strong>黑名单字符，对字符串的一次过滤后拼接出php,文件名.pphphp</p>
<h3 id="Pass-12-白名单校验（GET型0x00截断）"><a href="#Pass-12-白名单校验（GET型0x00截断）" class="headerlink" title="Pass-12 白名单校验（GET型0x00截断）"></a>Pass-12 白名单校验（GET型0x00截断）</h3><p>漏洞描述：</p>
<p>使用<strong>白名单</strong>限制上传文件类型，但上传文件的<strong>存放路径可控</strong></p>
<p>利用方法：</p>
<p>设置上传路径为upload/phpinfo.php%00 </p>
<p>添加phpinfo.php%00内容为了控制路径，上传文件后缀为白名单即可</p>
<p>例:test.jpg，保存后为**/upload/phpinfo.php%00test.jpg**</p>
<p>但服务端读取到**%00**时会自动结束，将文件内容保存至phpinfo.php中</p>
<p>PS:</p>
<p><strong>需要php的版本号低于5.3.29，且magic_quotes_gpc为关闭状态</strong></p>
<h3 id="Pass-13-白名单校验（POST型0x00截断）"><a href="#Pass-13-白名单校验（POST型0x00截断）" class="headerlink" title="Pass-13 白名单校验（POST型0x00截断）"></a>Pass-13 白名单校验（POST型0x00截断）</h3><p>漏洞描述：</p>
<p>使用白名单限制上传文件类型，但上传文件的存放路径可控，但因为是POST型，需要在16进制中修改，因为POST不会像GET那样对%00进行自动解码。</p>
<p><img src="/./%E9%9D%B6%E5%9C%BA%E6%97%A5%E8%AE%B0/P2"></p>
<p><img src="/./%E9%9D%B6%E5%9C%BA%E6%97%A5%E8%AE%B0/P1.jpeg"></p>
<h3 id="Pass-14-文件内容检测（文件头校验）"><a href="#Pass-14-文件内容检测（文件头校验）" class="headerlink" title="Pass-14 文件内容检测（文件头校验）"></a>Pass-14 文件内容检测（文件头校验）</h3><p>漏洞描述：</p>
<p>通过读文件的前2个字节，检测上传文件二进制的头信息，判断文件类型，利用图片马绕过检测。</p>
<p>利用方法：</p>
<p><strong>图片马制作</strong></p>
<p>在cmd里执行 <strong>copy logo.jpg/b+test.php/a test.jpg</strong></p>
<p>logo.jpg为任意图片<br>test.php为我们要插入的木马代码<br>test.jpg为我们要创建的图片马<br>名字可任意</p>
<h3 id="Pass-15-文件内容检测-（getimagesize-校验）"><a href="#Pass-15-文件内容检测-（getimagesize-校验）" class="headerlink" title="Pass-15 文件内容检测 （getimagesize()校验）"></a>Pass-15 文件内容检测 （getimagesize()校验）</h3><p>漏洞描述：</p>
<p>通过getimagesize()获取上传文件信息，图片马绕过</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">getimagesize() 函数用于获取图像大小及相关信息，成功返回一个数组<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Pass-16-文件内容检测（exif-imagetype-绕过）"><a href="#Pass-16-文件内容检测（exif-imagetype-绕过）" class="headerlink" title="Pass-16 文件内容检测（exif_imagetype()绕过）"></a>Pass-16 文件内容检测（exif_imagetype()绕过）</h3><p>漏洞描述：</p>
<p>利用php内置函数exif_imagetype()获取图片类型（需要开启php_exif模块）</p>
<p>利用方法：<br>(1)图片马</p>
<p>(2)预定义高度宽度：</p>
<p>例 .htaccess文件</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">文件内容
#define width 1337
#define height 1337
文件内容---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3)利用x00x00x8ax39x8ax39文件头</p>
<p>x00x00x8ax30x8ax39是wbmp文件的文件头，但0x00在.htaccess文件中为是注释符，不会影响文件本身。使用十六进制编辑器或者python的bytes字符类型(b’’)来进行添加。</p>
<p>payload:shell = b”\x00\x00\x8a\x39\x8a\x39”+b”00” + ‘文件内容’</p>
<h3 id="Pass-17-文件内容检测（二次渲染）"><a href="#Pass-17-文件内容检测（二次渲染）" class="headerlink" title="Pass-17 文件内容检测（二次渲染）"></a>Pass-17 文件内容检测（二次渲染）</h3><p>漏洞描述：</p>
<p>综合判断了后缀名、content-type，以及利用imagecreatefromgif判断是否为gif图片，并在最后对文件内容进行了二次渲染，修改文件内容</p>
<p>绕过方法：</p>
<p>上传一个GIF图片马，然后将其下载下来，查看其十六进制的文件内容，找到二次渲染后不变的地方，而这个地方就是可以插入一句话的地方</p>
<h3 id="Pass-18-逻辑漏洞（条件竞争）"><a href="#Pass-18-逻辑漏洞（条件竞争）" class="headerlink" title="Pass-18 逻辑漏洞（条件竞争）"></a>Pass-18 逻辑漏洞（条件竞争）</h3><p>漏洞描述：</p>
<p>先将文件上传到服务器，然后通过rename修改名称，再通过unlink删除文件，因此可以通过条件竞争的方式在unlink之前，访问webshell</p>
<p>利用方法：</p>
<p>使用burp或者python脚本对要上传的文件路径进行不断的访问(upload/webshell.php)，上传一个webshell.php，但访问该文件，会在目录下生成一个webshell，文件内容为：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'shell.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&lt;?php @eval($_POST["cmd"]) ?&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Ps：</p>
<pre><code>(1)不断上传文件，然后去访问

(2)不断访问，然后去上传文件
</code></pre>
<h1 id="Pass-19-逻辑漏洞（条件竞争-图片马）"><a href="#Pass-19-逻辑漏洞（条件竞争-图片马）" class="headerlink" title="Pass-19 逻辑漏洞（条件竞争-图片马）"></a>Pass-19 逻辑漏洞（条件竞争-图片马）</h1><p>漏洞描述：</p>
<p>后缀名做了白名单判断，然后会一步一步检查文件大小、文件是否存在等等，将文件上传后，对文件重新命名，同样存在条件竞争的漏洞。可以不断利用burp发送上传图片马的数据包，由于条件竞争，程序会出现来不及rename的问题，从而上传成功</p>
<p>利用方法：</p>
<p>区别于Pass-18,这里需要使用图片马</p>
<p>Pass-20 逻辑漏洞（小数点绕过）</p>
<p>漏洞描述：</p>
<p>使用pathinfo($file_name,PATHINFO_EXTENSION)的方式检查文件名后缀（从最后一个小数点进行截取），并使用的是黑名单方式。</p>
<p>利用方法：</p>
<p>上传一句话木马，在文件名后缀加一个小数点绕过 phpinfo.php.，上传成功可以直接访问phpinfo.php</p>
<h1 id="Pass-21-逻辑漏洞（数组绕过）"><a href="#Pass-21-逻辑漏洞（数组绕过）" class="headerlink" title="Pass-21 逻辑漏洞（数组绕过）"></a>Pass-21 逻辑漏洞（数组绕过）</h1><p>漏洞描述：</p>
<p>对参数$file进行判断，如果不是，将其修改为数组，但我们提前传入数组时，造成漏洞</p>
<p>利用方法：</p>
<p>数组绕过</p>
<p>防御文件上传</p>
<pre><code>1.检验扩展名是否在范围内

2.图像文件的情况下确认其文件头为图像类型，而不是伪装文件

3.针对上传文件大小进行约定（防止上传大文件进行DDOS攻击）

4.服务器端验证(防止前端绕过)，重新渲染图片b

5.上传的文件重命名，把文件地址隐藏了
</code></pre>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>
<script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>
    </div>
</div>

<footer class="footer">
    <ul class="list-inline text-center">
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/2438257908">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/kmoonn">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    </p>
</footer>
<script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>
<script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>
<script type="text/javascript" src="https://cdn.lanluo.cn/js/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":250,"height":350},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






    <style>
        #taboola-livere { display: none;}
    </style>
    <script type="text/javascript">
       (function() {
           if (typeof LivereTower === 'function') { return; }

           var j, d = document.getElementById('lv-container');

           d.setAttribute('data-id','city');
           d.setAttribute('data-uid' , 'MTAyMC81NzAwOS8zMzQ3Mw==');

           j = document.createElement('script');
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           d.appendChild(j);
       })();
    </script>
    <noscript>请激活JavaScript</noscript>
    </div>

</html>
